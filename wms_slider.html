<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hillshade Swipe — MORPHEUS</title>

  <!-- OpenLayers -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@9.2.4/ol.css"/>
  <script src="https://cdn.jsdelivr.net/npm/ol@9.2.4/dist/ol.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>

  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --accent-a: #58a6ff;  /* 2009 — blue */
      --accent-b: #f0883e;  /* 2018 — amber */
      --text: #e6edf3;
      --muted: #8b949e;
      --handle-size: 44px;
    }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      position: absolute;
      top: 0; left: 0; right: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      background: linear-gradient(to bottom, rgba(13,17,23,0.95), transparent);
      pointer-events: none;
    }

    .title-block { display: flex; flex-direction: column; gap: 2px; }
    .title { font-size: 1.1rem; font-weight: 800; letter-spacing: 0.04em; text-transform: uppercase; }
    .subtitle { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--muted); }

    .legend {
      display: flex;
      gap: 18px;
      pointer-events: none;
    }
    .legend-item {
      display: flex; align-items: center; gap: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.72rem;
      font-weight: 600;
      letter-spacing: 0.08em;
    }
    .legend-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
    }
    .dot-a { background: var(--accent-a); box-shadow: 0 0 8px var(--accent-a); }
    .dot-b { background: var(--accent-b); box-shadow: 0 0 8px var(--accent-b); }

    /* ── Map ── */
    #map {
      position: absolute;
      inset: 0;
    }

    /* ── Divider line ── */
    #swipe-line {
      position: absolute;
      top: 0; bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom,
        transparent 0%,
        rgba(255,255,255,0.06) 5%,
        rgba(255,255,255,0.35) 30%,
        rgba(255,255,255,0.5) 50%,
        rgba(255,255,255,0.35) 70%,
        rgba(255,255,255,0.06) 95%,
        transparent 100%
      );
      pointer-events: none;
      z-index: 10;
      transform: translateX(-50%);
      transition: left 0s;
    }

    /* ── Handle ── */
    #swipe-handle {
      position: absolute;
      top: 50%;
      z-index: 11;
      width: var(--handle-size);
      height: var(--handle-size);
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--border);
      transform: translate(-50%, -50%);
      cursor: grab;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      user-select: none;
    }
    #swipe-handle:hover {
      border-color: rgba(255,255,255,0.4);
      box-shadow: 0 4px 30px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.1);
      transform: translate(-50%, -50%) scale(1.08);
    }
    #swipe-handle.dragging {
      cursor: grabbing;
      border-color: rgba(255,255,255,0.6);
      box-shadow: 0 4px 40px rgba(0,0,0,0.9), 0 0 0 2px rgba(255,255,255,0.2);
      transform: translate(-50%, -50%) scale(1.12);
    }

    /* Arrow icons inside handle */
    .arrow {
      width: 0; height: 0;
      border-top: 5px solid transparent;
      border-bottom: 5px solid transparent;
    }
    .arrow-left  { border-right: 7px solid var(--muted); }
    .arrow-right { border-left:  7px solid var(--muted); }

    /* Half-color circles on handle */
    #swipe-handle::before, #swipe-handle::after {
      content: '';
      position: absolute;
      top: 50%; transform: translateY(-50%);
      width: 7px; height: 7px;
      border-radius: 50%;
    }
    #swipe-handle::before {
      left: 6px;
      background: var(--accent-a);
      box-shadow: 0 0 6px var(--accent-a);
    }
    #swipe-handle::after {
      right: 6px;
      background: var(--accent-b);
      box-shadow: 0 0 6px var(--accent-b);
    }

    /* ── Year labels that follow the divider ── */
    .year-tag {
      position: absolute;
      top: 50%;
      z-index: 12;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.65rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      padding: 4px 8px;
      border-radius: 3px;
      pointer-events: none;
      transform: translateY(-50%);
      transition: left 0s;
    }
    #tag-left {
      background: rgba(88,166,255,0.85);
      border: 1px solid rgba(88,166,255,0.95);
      color: #fff;
    }
    #tag-right {
      background: rgba(240,136,62,0.85);
      border: 1px solid rgba(240,136,62,0.95);
      color: #fff;
    }

    /* ── OL controls styling ── */
    .ol-control button {
      background: var(--surface) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      border-radius: 4px !important;
      font-family: 'Syne', sans-serif !important;
    }
    .ol-control button:hover { background: var(--border) !important; }
    .ol-zoom { top: auto !important; bottom: 40px !important; left: 16px !important; }
    .ol-attribution { display: none !important; }

    /* ── Loading overlay ── */
    #loading {
      position: absolute;
      inset: 0;
      z-index: 200;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      transition: opacity 0.6s;
    }
    #loading.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid var(--border);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-text {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.75rem;
      color: var(--muted);
      letter-spacing: 0.1em;
    }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">LOADING LAYERS…</div>
  </div>

  <div id="map"></div>

  <!-- Divider + handle -->
  <div id="swipe-line"></div>
  <div id="swipe-handle">
    <div class="arrow arrow-left"></div>
    <div class="arrow arrow-right"></div>
  </div>
  <div class="year-tag" id="tag-left">2009</div>
  <div class="year-tag" id="tag-right">2018</div>

  <header>
    <div class="title-block">
      <div class="title">MORPHEUS — Hillshade</div>
      <div class="subtitle">IRPI · CNR · Drag to compare</div>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot dot-a"></div>2009</div>
      <div class="legend-item"><div class="legend-dot dot-b"></div>2018</div>
    </div>
  </header>

  <script>
    const WMS_URL = 'https://hydrogeo-gis.irpi.cnr.it/index.php/lizmap/service?repository=hrg&project=MORPHEUS';

    // ── WMS layers ──
    function makeWMS(layerName) {
      return new ol.layer.Image({
        source: new ol.source.ImageWMS({
          url: WMS_URL,
          params: {
            SERVICE: 'WMS',
            VERSION: '1.3.0',
            LAYERS: layerName,
            FORMAT: 'image/jpeg',
            CRS: 'EPSG:3857'
          },
          ratio: 1,
          serverType: 'qgis'
        })
      });
    }

    const layer2009 = makeWMS('Hillshade_2009');
    const layer2018 = makeWMS('Hillshade_But_2018_1m');

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({ source: new ol.source.OSM({ attributions: [] }) }),
        layer2009,
        layer2018
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([13.036, 46.513]),
        zoom: 13
      }),
      controls: ol.control.defaults.defaults({ attribution: false })
    });

    // ── Hide loading when first tile loaded ──
    let loaded = false;
    map.on('rendercomplete', () => {
      if (!loaded) {
        loaded = true;
        document.getElementById('loading').classList.add('hidden');
      }
    });

    // ── Swipe state ──
    let swipeRatio = 0.5;

    function getSwipeX() {
      return map.getSize()[0] * swipeRatio;
    }

    function updateUI() {
      const x = getSwipeX();
      const mapEl = document.getElementById('map');
      const rect = mapEl.getBoundingClientRect();
      const absX = rect.left + x;

      document.getElementById('swipe-line').style.left   = x + 'px';
      document.getElementById('swipe-handle').style.left = x + 'px';

      const tagLeft  = document.getElementById('tag-left');
      const tagRight = document.getElementById('tag-right');
      tagLeft.style.left  = (x - tagLeft.offsetWidth - 12) + 'px';
      tagRight.style.left = (x + 12) + 'px';

      map.render();
    }

    // ── Clip layer2018 to right side ──
    layer2018.on('prerender', function(e) {
      const ctx = e.context;
      const size = map.getSize();
      const x = getSwipeX();
      ctx.save();
      ctx.beginPath();
      ctx.rect(x, 0, size[0] - x, size[1]);
      ctx.clip();
    });
    layer2018.on('postrender', function(e) {
      e.context.restore();
    });

    // ── Drag logic ──
    const handle = document.getElementById('swipe-handle');
    let dragging = false;

    function onDragStart(e) {
      dragging = true;
      handle.classList.add('dragging');
      e.preventDefault();
    }
    function onDragMove(e) {
      if (!dragging) return;
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const rect = document.getElementById('map').getBoundingClientRect();
      const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
      swipeRatio = x / rect.width;
      updateUI();
    }
    function onDragEnd() {
      dragging = false;
      handle.classList.remove('dragging');
    }

    handle.addEventListener('mousedown',  onDragStart);
    handle.addEventListener('touchstart', onDragStart, { passive: false });
    document.addEventListener('mousemove',  onDragMove);
    document.addEventListener('touchmove',  onDragMove, { passive: false });
    document.addEventListener('mouseup',   onDragEnd);
    document.addEventListener('touchend',  onDragEnd);

    // ── Initial render ──
    map.once('postrender', updateUI);
    window.addEventListener('resize', updateUI);
  </script>
</body>
</html>
